<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Robot Arm Pro Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; 
            overflow: hidden; 
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* STRICT SIDE-BY-SIDE GRID */
        .controller-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Exactly two equal halves */
            width: 100%;
            flex-grow: 1; /* Fills the remaining space below the title */
            align-items: center;
            justify-items: center;
        }

        .joystick-zone {
            width: 160px; height: 160px;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid rgba(59, 130, 246, 0.4);
            border-radius: 50%;
            position: relative;
        }

        @media (max-width: 600px) {
            .joystick-zone { width: 130px; height: 130px; }
        }
    </style>
</head>
<body>

    <div class="text-center pt-6">
        <h1 class="text-2xl font-black italic tracking-tighter text-blue-400">ARM CONTROLLER</h1>
        <div id="status" class="mt-1 px-3 py-0.5 rounded-full bg-red-500/20 text-red-400 text-[10px] font-bold uppercase inline-block">
            Offline
        </div>
        <button onclick="toggleFullScreen()" class="block mx-auto mt-2 text-[10px] text-gray-500 underline">Toggle Fullscreen</button>
    </div>

    <div class="controller-grid">
        
        <div class="flex flex-col items-center">
            <span class="mb-4 text-blue-400 font-bold text-xs uppercase tracking-widest">Pan (L/R)</span>
            <div id="joyPan" class="joystick-zone"></div>
        </div>

        <div class="flex flex-col items-center">
            <span class="mb-4 text-emerald-400 font-bold text-xs uppercase tracking-widest">Tilt (U/D)</span>
            <div id="joyTilt" class="joystick-zone"></div>
        </div>

    </div>

    <script>
        const HOST = 'test.mosquitto.org';
        const PORT = 8081; 
        const CLIENT_ID = 'web_robot_' + Math.floor(Math.random() * 1000);
        
        let mqtt = new Paho.MQTT.Client(HOST, PORT, CLIENT_ID);

        mqtt.onConnectionLost = (err) => { 
            document.getElementById('status').innerText = "Offline";
            document.getElementById('status').className = "mt-1 px-3 py-0.5 rounded-full bg-red-500/20 text-red-400 text-[10px] font-bold uppercase inline-block";
        };

        mqtt.connect({ useSSL: true, onSuccess: () => {
            document.getElementById('status').innerText = "Online";
            document.getElementById('status').className = "mt-1 px-3 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase inline-block";
        }});

        function publish(topic, val) {
            if (mqtt.isConnected()) {
                let msg = new Paho.MQTT.Message(String(Math.round(val)));
                msg.destinationName = topic;
                mqtt.send(msg);
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }

        // Joystick 1: Pan (Corrected Direction)
        const panJoy = nipplejs.create({
            zone: document.getElementById('joyPan'),
            mode: 'static', position: {left: '50%', top: '50%'},
            color: '#3b82f6', size: 130, lockX: true
        });

        panJoy.on('move', (evt, data) => {
            if (data.direction) {
                let force = Math.min(data.force, 1);
                let angle = data.direction.x === 'right' ? 90 + (90 * force) : 90 - (90 * force);
                publish("device/joraj/arm/pan", angle);
            }
        });
        panJoy.on('end', () => publish("device/joraj/arm/pan", 90));

        // Joystick 2: Tilt (Corrected Direction)
        const tiltJoy = nipplejs.create({
            zone: document.getElementById('joyTilt'),
            mode: 'static', position: {left: '50%', top: '50%'},
            color: '#10b981', size: 130, lockY: true
        });

        tiltJoy.on('move', (evt, data) => {
            if (data.direction) {
                let force = Math.min(data.force, 1);
                let angle = data.direction.y === 'up' ? 90 - (90 * force) : 90 + (90 * force);
                publish("device/joraj/arm/tilt", angle);
            }
        });
        tiltJoy.on('end', () => publish("device/joraj/arm/tilt", 90));
    </script>
</body>
</html>
