<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Arm Pro Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }
        .joystick-zone {
            width: 280px; height: 280px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="text-center mb-8">
        <h1 class="text-5xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
            ROBOT ARM V2
        </h1>
        <div id="status" class="mt-4 px-4 py-1 rounded-full bg-red-500/20 text-red-400 text-xs font-bold uppercase tracking-widest">
            Connecting...
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-16">
        <div class="flex flex-col items-center">
            <span class="mb-4 text-blue-400 font-bold tracking-widest text-sm">↔ PAN (LEFT/RIGHT)</span>
            <div id="joyPan" class="joystick-zone"></div>
        </div>

        <div class="flex flex-col items-center">
            <span class="mb-4 text-emerald-400 font-bold tracking-widest text-sm">↕ TILT (UP/DOWN)</span>
            <div id="joyTilt" class="joystick-zone"></div>
        </div>
    </div>

    <script>
        const HOST = 'test.mosquitto.org';
        const PORT = 8081; 
        const CLIENT_ID = 'web_robot_' + Math.floor(Math.random() * 1000);
        
        let mqtt = new Paho.MQTT.Client(HOST, PORT, CLIENT_ID);

        mqtt.onConnectionLost = (err) => { 
            const s = document.getElementById('status');
            s.innerText = "Connection Lost";
            s.className = "mt-4 px-4 py-1 rounded-full bg-red-500/20 text-red-400 text-xs font-bold uppercase tracking-widest";
        };

        mqtt.connect({ useSSL: true, onSuccess: () => {
            const s = document.getElementById('status');
            s.innerText = "System Online";
            s.className = "mt-4 px-4 py-1 rounded-full bg-emerald-500/20 text-emerald-400 text-xs font-bold uppercase tracking-widest";
        }});

        function publish(topic, val) {
            if (mqtt.isConnected()) {
                let msg = new Paho.MQTT.Message(String(Math.round(val)));
                msg.destinationName = topic;
                mqtt.send(msg);
            }
        }

        // --- PAN LOGIC (REVERSED) ---
        const panJoy = nipplejs.create({
            zone: document.getElementById('joyPan'),
            mode: 'static', position: {left: '50%', top: '50%'},
            color: '#3b82f6', size: 160, lockX: true
        });

        panJoy.on('move', (evt, data) => {
            if (data.direction) {
                let force = Math.min(data.force, 1);
                // REVERSED LOGIC: Right now subtracts, Left now adds
                let angle = data.direction.x === 'right' ? 90 - (90 * force) : 90 + (90 * force);
                publish("device/joraj/arm/pan", angle);
            }
        });
        panJoy.on('end', () => publish("device/joraj/arm/pan", 90));

        // --- TILT LOGIC (REVERSED) ---
        const tiltJoy = nipplejs.create({
            zone: document.getElementById('joyTilt'),
            mode: 'static', position: {left: '50%', top: '50%'},
            color: '#10b981', size: 160, lockY: true
        });

        tiltJoy.on('move', (evt, data) => {
            if (data.direction) {
                let force = Math.min(data.force, 1);
                // REVERSED LOGIC: Up now subtracts, Down now adds
                let angle = data.direction.y === 'up' ? 90 - (90 * force) : 90 + (90 * force);
                publish("device/joraj/arm/tilt", angle);
            }
        });
        tiltJoy.on('end', () => publish("device/joraj/arm/tilt", 90));
    </script>
</body>
</html>
